AWSTemplateFormatVersion: '2010-09-09'
Description: ''
Resources:
  ApiTierAlb:
    Properties:
      Subnets:
        - Fn::ImportValue: !Sub "${NetworksStackNameParm}-PublicGeneralPurposeSubnetAOutput"
        - Fn::ImportValue: !Sub "${NetworksStackNameParm}-PublicGeneralPurposeSubnetBOutput"
        - Fn::ImportValue: !Sub "${NetworksStackNameParm}-PublicGeneralPurposeSubnetCOutput"
      SecurityGroups:
        - Fn::ImportValue: !Sub "${NetworksStackNameParm}-AppTierAlbSecurityGroupIdOutput"
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
  ApiTierAlbSslListener:
    Properties:
      LoadBalancerArn: !Ref ApiTierAlb
      DefaultActions:
        - TargetGroupArn: !Ref ApiTierAlbTargetGroup
          Type: forward
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: arn:aws:acm:us-west-2:085224677438:certificate/d203faf8-8641-4406-b117-75bd35c100be
    Type: AWS::ElasticLoadBalancingV2::Listener
  AlbCname:
    Type: AWS::Route53::RecordSet
    Properties:
      Type: A
      HostedZoneName:
        "Fn::Join":
          - ""
          - - !Ref DomainNameParm
            - "."
      Name:
        "Fn::Join":
          - ""
          - - !Ref HostNameParm
            - "."
            - !Ref DomainNameParm
      AliasTarget:
        HostedZoneId: !GetAtt ApiTierAlb.CanonicalHostedZoneID
        DNSName: !GetAtt ApiTierAlb.DNSName

  ApiTierAlbTargetGroup:
    Properties:
      HealthCheckPath: !Ref HealthCheckPathParm
      HealthCheckIntervalSeconds: 30
      HealthCheckProtocol: HTTP
      HealthCheckPort: 80
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 5
      UnhealthyThresholdCount: 3
      VpcId:
        Fn::ImportValue: !Sub "${NetworksStackNameParm}-VpcIdOutput"
      Port: 80
      Protocol: HTTP
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
  ApiTierAlbListenerRule:
    Properties:
      Actions:
        - TargetGroupArn: !Ref ApiTierAlbTargetGroup
          Type: forward
      Conditions:
        - Field: path-pattern
          Values:
            - !Ref EnvironmentParm
      ListenerArn: !Ref ApiTierAlbSslListener
      Priority: 100
    Type: AWS::ElasticLoadBalancingV2::ListenerRule

  ApiTierAutoscalingGroup:
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MaxBatchSize: 1
        MinInstancesInService: 2
        SuspendProcesses:
          - HealthCheck
          - ReplaceUnhealthy
          - AZRebalance
          - AlarmNotification
          - ScheduledActions
    Properties:
      MaxSize: !Ref ApiTierAsgMaxSizeParm
      HealthCheckType: ELB
      TargetGroupARNs:
        - !Ref ApiTierAlbTargetGroup
      MinSize: !Ref ApiTierAsgMinSizeParm
      AvailabilityZones: !Ref ApiTierAsgAzsParm
      DesiredCapacity: !Ref ApiTierAsgDesiredCapacityParm
      VPCZoneIdentifier:
        - Fn::ImportValue: !Sub "${NetworksStackNameParm}-PrivateGeneralPurposeSubnetAOutput"
        - Fn::ImportValue: !Sub "${NetworksStackNameParm}-PrivateGeneralPurposeSubnetBOutput"
        - Fn::ImportValue: !Sub "${NetworksStackNameParm}-PrivateGeneralPurposeSubnetCOutput"
      LaunchConfigurationName:
        Fn::ImportValue:
          !Sub "${LaunchConfigurationStackNameParm}-ApiTierLaunchConfigurationOutput"
    Type: AWS::AutoScaling::AutoScalingGroup
  CustomerAppAutoscalingGroup:
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MaxBatchSize: 1
        MinInstancesInService: 2
        SuspendProcesses:
          - HealthCheck
          - ReplaceUnhealthy
          - AZRebalance
          - AlarmNotification
          - ScheduledActions
    Properties:
      MaxSize: !Ref CustomerAppAsgMaxSizeParm
      MinSize: !Ref CustomerAppAsgMinSizeParm
      AvailabilityZones: !Ref CustomerAppAsgAzsParm
      DesiredCapacity: !Ref CustomerAppAsgDesiredCapacityParm
      VPCZoneIdentifier:
        - Fn::ImportValue: !Sub "${NetworksStackNameParm}-PrivateGeneralPurposeSubnetAOutput"
        - Fn::ImportValue: !Sub "${NetworksStackNameParm}-PrivateGeneralPurposeSubnetBOutput"
        - Fn::ImportValue: !Sub "${NetworksStackNameParm}-PrivateGeneralPurposeSubnetCOutput"
      LaunchConfigurationName:
        Fn::ImportValue:
          !Sub "${LaunchConfigurationStackNameParm}-CustomerAppLaunchConfigurationOutput"
    Type: AWS::AutoScaling::AutoScalingGroup
  CustomerAppTierScaleOutPolicy:
    Properties:
      AutoScalingGroupName: !Ref ApiTierAutoscalingGroup
      AdjustmentType: ChangeInCapacity
      PolicyType: SimpleScaling
      ScalingAdjustment: 1
    Type: AWS::AutoScaling::ScalingPolicy
  CustomerAppTierCpuCreditsUsageHighAlarm:
    Properties:
      ComparisonOperator: GreaterThanThreshold
      Threshold: !Ref CustomerAppTierCpuCreditsUsageHighThresholdParm
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref ApiTierAutoscalingGroup
      EvaluationPeriods: 1
      MetricName: CPUCreditUsage
      Namespace: AWS/EC2
      Period: 300
      Statistic: Average
      AlarmActions:
        - !Ref CustomerAppTierScaleOutPolicy
    Type: AWS::CloudWatch::Alarm
  CustomerAppTierScaleInPolicy:
    Properties:
      AutoScalingGroupName: !Ref ApiTierAutoscalingGroup
      AdjustmentType: ChangeInCapacity
      PolicyType: SimpleScaling
      ScalingAdjustment: -1
    Type: AWS::AutoScaling::ScalingPolicy
  CustomerAppTierCpuCreditsUsageLowAlarm:
    Properties:
      ComparisonOperator: LessThanThreshold
      Threshold: !Ref CustomerAppTierCpuCreditsUsageLowThresholdParm
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref ApiTierAutoscalingGroup
      EvaluationPeriods: 36
      MetricName: CPUCreditUsage
      Namespace: AWS/EC2
      Period: 300
      Statistic: Average
      AlarmActions:
        - !Ref CustomerAppTierScaleInPolicy
    Type: AWS::CloudWatch::Alarm
Parameters:
  EnvironmentParm:
    Type: String
  ApiTierAsgMinSizeParm:
    Type: String
  ApiTierAsgMaxSizeParm:
    Type: String
  ApiTierAsgDesiredCapacityParm:
    Type: String
  ApiTierAsgAzsParm:
    Type: List<AWS::EC2::AvailabilityZone::Name>


  CustomerAppAsgMinSizeParm:
    Type: String
  CustomerAppAsgMaxSizeParm:
    Type: String
  CustomerAppAsgDesiredCapacityParm:
    Type: String
  CustomerAppAsgAzsParm:
    Type: List<AWS::EC2::AvailabilityZone::Name>


  LaunchConfigurationStackNameParm:
    Type: String
  NetworksStackNameParm:
    Type: String

  CustomerAppTierCpuCreditsUsageHighThresholdParm:
    Type: Number
  CustomerAppTierCpuCreditsUsageLowThresholdParm:
    Type: Number
  HealthCheckPathParm:
    Type: String
  DomainNameParm:
    Type: String
  HostNameParm:
    Type: String
